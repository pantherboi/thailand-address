<html >
<head>
     <title>ที่อยู่ suggestion </title>
</head>     
<style>
.suggest-list {
    z-index: 50;
    position: absolute;
    z-index: 100;
    width: 100%;
    top: bottomTop;
    left: bottomLeft;
    width: bottomWidth;
    height: bottomHeight; 
}

.suggest-item {
     z-index: 100;
     /* border: 1px solid #eee; */
     padding: 2px;
     background-color: white;
     cursor: pointer;
}
.suggest-item.hightlight {
     background-color: #fce9e9;
}
.suggest-item-value {
     display: none;
}
.addrValue {
     display: none;
}
.highlight {
  background-color: yellow;
  font-weight: bolder;
}

</style>

<script type="text/javascript" >
     var mapProvince = [];
     var mapDistrict = [];
     var mapSubDistrict = [];
     initData();
     function initData(){
          loadData("../data/province.utf8.txt",initProvince);
          loadData("../data/district.utf8.txt",initDistrict);
          loadData("../data/subdistrict.utf8.txt",initSubDistrict);
     }
     function findProvinceByID(id){
          return mapProvince.find(obj => obj.provinceID === id)
     }
     function findProvinceByLabel(label){
          return mapProvince.filter(function(entry){
               if(this.count < this.max && entry.provinceLabel.startsWith(label)){
                    this.count++;
                    return true;
               }else return false;
          },{count:0,max:20});
     }
     function findDistrictByID(id){
          return mapDistrict.find(obj => obj.districtID === id)
     }
     function findDistrictByLabel(label){
          return mapDistrict.filter(function(entry){
               if(this.count < this.max && entry.districtLabel.startsWith(label)){
                    this.count++;
                    return true;
               }else return false;
          },{count:0,max:100});
     }
     function findSubDistrictByID(id){
          return mapDistrict.find(obj => obj.subDistrictID === id)
     }
     function findSubDistrictByLabel(label){
          return mapSubDistrict.filter(function(entry){
               if(this.count < this.max && entry.subDistrictLabel.startsWith(label)){
                    this.count++;
                    return true;
               }else return false;
          },{count:0,max:20});
     }
     function findSubDistrictByZipCode(zipCode){
          return mapSubDistrict.filter(function(entry){
               if(this.count < this.max && entry.zipCode.startsWith(zipCode)){
                    this.count++;
                    return true;
               }else return false;
          },{count:0,max:20});
     }
     function findSubDistrictByDistrictIDs(districtIDs){
          return mapSubDistrict.filter(function(entry){
               if(this.count < this.max && districtIDs.find((value) => value===entry.subDistrictID.substring(0,4))){
                    this.count++;
                    return true;
               }else return false;
          },{count:0,max:20});
     }
     function findSubDistrictByProvinceIDs(provinceIDs){
          return mapSubDistrict.filter(function(entry){
               if(this.count < this.max && provinceIDs.find((value) => value===entry.subDistrictID.substring(0,2))){
                    this.count++;
                    return true;
               }else return false;
          },{count:0,max:20});
     }
     function loadData(path, callback){
         const xhr = new XMLHttpRequest();
     //     xhr.overrideMimeType('text/xml; charset=iso-8859-11');
         xhr.overrideMimeType('text/xml; charset=UTF-8');
         xhr.onreadystatechange = function () {
               if(xhr.readyState === 4 && xhr.status === 200 ){
                    const res= xhr.responseText;
                    const allLines = res.split(/\r?\n/);
                    console.log(allLines);
                    callback(allLines);
               }
         }
         xhr.open("GET",path );
         xhr.send();
     }

     function initProvince(data){
          data.forEach((line) => {
                    const val = line.split("|");
                    if(val.length > 1){
                         entry = {
                                provinceID: val[0],
                                provinceLabel: val[1]
                         };
                         mapProvince.push(entry);
                    }
               }
          );
     }
     function initDistrict(data){
          data.forEach((line) => {
                    const val = line.split("|");
                    if(val.length > 1){
                         entry = {
                              districtID: val[0],
                              districtLabel: val[1]
                         };
                         mapDistrict.push(entry);
                    }
               }
          );
     }
     function initSubDistrict(data){
          data.forEach((line) => {
                    const val = line.split("|");
                    if(val.length > 2){
                         entry = {
                              subDistrictID: val[0],
                              subDistrictLabel: val[1],  
                              zipCode: val[2]
                         };
                         mapSubDistrict.push(entry);
                    }
               }
          );
     }
     function removeAllChilds(ele){
          while (ele.firstChild) {
               ele.removeChild(ele.lastChild);
          }
     }
     function randomString(len){
          for(let c = ''; c.length < len;) c += Math.random().toString(36).substr(2, 1)
          return c;
     }
     function randomNumber(len){
          return Math.random(1000).toFixed(len).split('.')[1];
     }
     
     function buildSuggestValueFromSubDistrict(entry){
          // console.log("buildSuggestValueFromSubDistrict:"+entry.subDistrictID);
          entry.provinceID = entry.subDistrictID.substring(0,2);
          entry.districtID = entry.subDistrictID.substring(0,4);
          entry.districtLabel = findDistrictByID(entry.districtID).districtLabel;
          entry.provinceLabel = findProvinceByID(entry.provinceID).provinceLabel;
          return entry;
     }

     function getSuggestAddress(type,value){
          let suggestValues = [];
          if(value.length == 0 ) return suggestValues;
          
          
          if(type === 'zipCode'  ){
               suggestValues = findSubDistrictByZipCode(value);
          }else if(type === 'subDistrict'){
               suggestValues = findSubDistrictByLabel(value);
          }else if(type === 'district'){
               districts = findDistrictByLabel(value).map(function(e){return e.districtID});
               suggestValues = findSubDistrictByDistrictIDs(districts);
          }else if(type === 'province'){
               provinces = findProvinceByLabel(value).map(function(e){return e.provinceID});
               suggestValues = findSubDistrictByProvinceIDs(provinces);
          }
          
          suggestValues.forEach(function(entry){
               entry = buildSuggestValueFromSubDistrict(entry);
          })

          return suggestValues;
     }
 

     function hightlightText(isHighlight,baseText,text){
          if(!isHighlight) return baseText;
          const index = baseText.indexOf(text);
          let result = baseText;
          if (index >= 0) { 
               result = baseText.substring(0,index) + "<span class='highlight'>" + baseText.substring(index,index+text.length) + "</span>" + baseText.substring(index + text.length);
          }
          return result;

     }
     function fetchSuggestItems(type,value,target1,target2,target3,target4,target5,target6,target7,target8){
          let items = new Array();

          const suggestValues = getSuggestAddress(type,value);
          // const suggestValues = getSuggestAddressMock(type,value);
          // console.log("suggestValues:"+suggestValues);
          // console.log("suggestValues.size:" + suggestValues.length);
          for(let i = 0 ; i< suggestValues.length; i++){
               //console.log("suggestValues["+i+"]size:" +suggestValues[i].length);
               const item = document.createElement("div");
               item.classList.add("suggest-item");

               // item.innerHTML =   
               // suggestValues[i].subDistrictLabel + " > "+  
               // suggestValues[i].districtLabel + " > "+  
               // suggestValues[i].provinceLabel   + " > "+  
               // suggestValues[i].zipCode;
               
               item.innerHTML =   
               hightlightText(type ==='subDistrict',suggestValues[i].subDistrictLabel,value) + " > "+  
               hightlightText(type ==='district',suggestValues[i].districtLabel,value) + " > "+  
               hightlightText(type ==='province',suggestValues[i].provinceLabel,value) + " > "+  
               hightlightText(type ==='zipCode',suggestValues[i].zipCode,value) ;

               
               const subItem = document.createElement("div");
               subItem.classList.add("suggest-item-value");
               
               subItem.innerText = 
               suggestValues[i].subDistrictID + "," + suggestValues[i].subDistrictLabel + "," + 
               suggestValues[i].districtID    + "," + suggestValues[i].districtLabel + "," + 
               suggestValues[i].provinceID    + "," + suggestValues[i].provinceLabel+ "," + 
               suggestValues[i].zipCode

               item.addEventListener('mousedown',  function(e) {applyTargetAddress(target1,target2,target3,target4,target5,target6,target7,target8,subItem.innerText);item.parentElement.style.display ="none";});
               item.addEventListener('mouseenter', function(e) {
                    const suggestItemElems = document.querySelectorAll('.suggest-item');
                    suggestItemElems.forEach(f => {
                         f.classList.remove('hightlight');
                    })
                    e.target.classList.add('hightlight');
               })
               item.appendChild(subItem);
               items.push(item);
          }
          
          return items;
     }

     function buildSuggestList(ele,type,listid,target1,target2,target3,target4,target5,target6,target7,target8){
          // console.log("buildSuggestList");
          const suggestList = document.getElementById(listid);
          suggestList.style.display ="block";
          removeAllChilds(suggestList);
          const suggestItems =  fetchSuggestItems(type,ele.value,target1,target2,target3,target4,target5,target6,target7,target8);
          for(let  i = 0 ; i< suggestItems.length ; i++){
               const child = suggestItems[i];
               suggestList.appendChild(child);
               
          }
          ele.addEventListener('blur',function(event){suggestList.style.display ="none";});
     }
     function applyTargetAddress(target1,target2,target3,target4,target5,target6,target7,target8,targetValue ){
          // console.log("applyTargetAddress");
          const array = targetValue.split(",");
          document.getElementById(target1).value = array[0];
          document.getElementById(target2).value = array[1];
          document.getElementById(target3).value = array[2];
          document.getElementById(target4).value = array[3];
          document.getElementById(target5).value = array[4];
          document.getElementById(target6).value = array[5];
          document.getElementById(target7).value = array[6];
          document.getElementById(target8).value = array[6];
          
     }
     const triggerElementEvent = (el, eventName) => {
          const event = document.createEvent('HTMLEvents');
          event.initEvent(eventName, true, false);
          el.dispatchEvent(event);
     };
</script>
<body>
     <h3> address 1 </h3>
     <table class="section-layout full-width" cellspacing="3" cellpadding="3">
          <tbody>
               
               <tr>
                    <td class="label">แขวง/ตำบล</td>
                    <td class="data">
                         <input id="addr1label" class="addrLabel" >
                         <input id="addr1" class="addrValue" name="formData.companyAddressDistrict"  >
                         <div class="suggest-list" id="list1"></div>
                    </td>
               </tr>
               <tr>
                    <td class="label">เขต/อำเภอ</td>
                    <td class="data">
                         <input id="addr2label" class="addrLabel">
                         <input id="addr2" class="addrValue" name="formData.companyAddressAmphur"   >
                         <div class="suggest-list" id="list2"></div>
                    </td>
               </tr>
               <tr>
                    <td class="label">จังหวัด</td>
                    <td class="data">
                         <input id="addr3label" class="addrLabel">
                         <input id="addr3"  class="addrValue"  name="formData.companyAddressProvince">
                         <div class="suggest-list" id="list3"></div>
                    </td>
               </tr>
               <tr>
                    <td class="label">รหัสไปรษณีย์</td>
                    <td class="data">
                         <input id="addr4label"  class="addrLabel">
                         <input id="addr4" class="addrValue" name="formData.companyAddressPostalCode" >
                         <div class="suggest-list" id="list4"></div>
                    </td>
               </tr>
          </tbody>
     </table>

     <h3>address 2 </h3>
     <table class="section-layout full-width" cellspacing="3" cellpadding="3">
          <tbody>
               <tr>
                    <td class="label">แขวง/ตำบล</td>
                    <td class="data"><input name="formData.requesterAddressDistrict"></td>
               </tr>
               <tr>
                    <td class="label">เขต/อำเภอ</td>
                    <td class="data"><input name="formData.requesterAddressAmphur"></td>
               </tr>
               <tr>
                    <td class="label">จังหวัด</td>
                    <td class="data"><input name="formData.requesterAddressProvince"></td>
               </tr>
               <tr>
                    <td class="label">รหัสไปรษณีย์</td>
                    <td class="data"><input name="formData.requesterAddressPostalCode"></td>
               </tr>
          </tbody>
     </table>
</body>
<script>
     const addr1 = document.getElementById('addr1label');
     const addr2 = document.getElementById('addr2label');
     const addr3 = document.getElementById('addr3label');
     const addr4 = document.getElementById('addr4label');
     const handler1 = function(){buildSuggestList(addr1,'subDistrict','list1','addr1','addr1label','addr2','addr2label','addr3','addr3label','addr4','addr4label')};
     const handler2 = function(){buildSuggestList(addr2,'district','list2','addr1','addr1label','addr2','addr2label','addr3','addr3label','addr4','addr4label')};
     const handler3 = function(){buildSuggestList(addr3,'province','list3','addr1','addr1label','addr2','addr2label','addr3','addr3label','addr4','addr4label')};
     const handler4 = function(){buildSuggestList(addr4,'zipCode','list4','addr1','addr1label','addr2','addr2label','addr3','addr3label','addr4','addr4label')};

     addr1.addEventListener('focus', handler1);
     addr1.addEventListener('input', handler1);
     addr2.addEventListener('focus', handler2);
     addr2.addEventListener('input', handler2);
     addr3.addEventListener('focus', handler3);
     addr3.addEventListener('input', handler3);
     addr4.addEventListener('focus', handler4);
     addr4.addEventListener('input', handler4);

     const elements = document.getElementsByClassName("addrLabel");
     
     for (let i = 0; i < elements.length; i++) {
          elements[i].addEventListener('keydown', function(e){ 
               const suggestItems = e.target.parentElement.querySelectorAll('.suggest-item');
               
               if(suggestItems.length == 0 ) return;
               let hightLightChildAt = -1 ;
              
               for(let j = 0 ; j< suggestItems.length ; j++){
                     if(suggestItems[j].classList.contains('hightlight')) {
                         hightLightChildAt = j; break;
                     } 
               }     
               
               const removeHightlight = function(targetEles){
                    for(let j = 0 ; j < targetEles.length ; j++)
                         targetEles[j].classList.remove('hightlight');
               }
               
               const pressed = event.key;
               if(pressed == 'Enter'){
                    console.log(suggestItems[hightLightChildAt]);
                    triggerElementEvent(suggestItems[hightLightChildAt],'mousedown');
                  
               }
               else if(hightLightChildAt == -1){
                    removeHightlight(suggestItems);
                    suggestItems[0].classList.add('hightlight');
               }
               else if (pressed == 'ArrowDown') {
                    removeHightlight(suggestItems);
                    if(hightLightChildAt == suggestItems.length -1 ) hightLightChildAt = 0
                    else hightLightChildAt++;
                    suggestItems[hightLightChildAt].classList.add('hightlight');
               }
               else if (pressed == 'ArrowUp') {
                    removeHightlight(suggestItems);
                    if(hightLightChildAt == 0 ) hightLightChildAt =  suggestItems.length-1;
                    else hightLightChildAt--;
                    suggestItems[hightLightChildAt].classList.add('hightlight');
               }
          }, false);
     }
</script>
</html>